<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾å“¡è‚²æˆã‚²ãƒ¼ãƒ  - ï¼§ï¼¯ï¼²ï¼¯å•†äº‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #e0f2ff 0, #f5f7ff 45%, #fdf6ec 100%);
    }

    .game {
      width: 390px;
      max-width: 95vw;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      padding: 18px 18px 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      position: relative;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .company-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .money-line {
      display: flex;
      justify-content: flex-end;
      font-size: 11px;
      color: #0f172a;
      margin-bottom: 4px;
      gap: 8px;
    }

    .money-line span.label {
      color: #6b7280;
    }

    .employee-area {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 12px;
      padding: 10px 10px;
      border-radius: 18px;
      background: linear-gradient(120deg, #e0f2fe, #eef2ff);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    /* ç¤¾å“¡ã‚¢ãƒã‚¿ãƒ¼ */
    .avatar-wrapper {
      position: relative;
      width: 92px;
      height: 92px;
      flex-shrink: 0;
    }

    .avatar-circle {
      position: absolute;
      inset: 0;
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.25s ease;
    }

    .stage-junior {
      background: radial-gradient(circle at top, #bfdbfe, #60a5fa);
    }
    .stage-mid {
      background: radial-gradient(circle at top, #a5b4fc, #6366f1);
    }
    .stage-leader {
      background: radial-gradient(circle at top, #f9a8d4, #ec4899);
    }
    .stage-manager {
      background: radial-gradient(circle at top, #fbbf24, #f97316);
    }

    .avatar-body {
      width: 70%;
      height: 80%;
      background: #f1f5f9;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.18);
    }

    .head {
      width: 52px;
      height: 52px;
      background: #fed7aa;
      border-radius: 50%;
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    }

    .hair {
      position: absolute;
      width: 54px;
      height: 28px;
      background: #1f2937;
      border-radius: 50px 50px 34px 34px;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
    }

    .eye {
      width: 7px;
      height: 7px;
      background: #111827;
      border-radius: 50%;
      position: absolute;
      top: 23px;
    }

    .eye.left {
      left: 18px;
    }
    .eye.right {
      right: 18px;
    }

    .eye.happy::after {
      content: "";
      position: absolute;
      width: 7px;
      height: 5px;
      border-radius: 50%;
      border-bottom: 2px solid #0f172a;
      top: -1px;
      left: 0;
    }

    .eye.tired::after {
      content: "";
      position: absolute;
      width: 9px;
      height: 2px;
      border-radius: 999px;
      background: #0f172a;
      top: 2px;
      left: -1px;
    }

    .mouth {
      position: absolute;
      width: 18px;
      height: 10px;
      border-radius: 0 0 16px 16px;
      border-bottom: 2px solid #b91c1c;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .mouth.smile {
      border-bottom-width: 3px;
    }
    .mouth.neutral {
      border-bottom: none;
      border-top: 2px solid #374151;
      height: 4px;
      bottom: 14px;
    }
    .mouth.sad {
      border-radius: 16px 16px 0 0;
      border-bottom: none;
      border-top: 2px solid #b91c1c;
      height: 8px;
      bottom: 14px;
    }

    .suit {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 50%;
      background: linear-gradient(135deg, #111827, #1f2933);
      clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
    }

    .shirt {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 30px;
      background: #f9fafb;
      clip-path: polygon(0 0, 100% 0, 82% 100%, 18% 100%);
    }

    .tie {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 26px;
      background: linear-gradient(180deg, #fb7185, #e11d48);
      clip-path: polygon(50% 0, 90% 28%, 70% 100%, 30% 100%, 10% 28%);
    }

    .stage-pill {
      position: absolute;
      left: 8px;
      top: 8px;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
    }

    .status-texts {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .name-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .name {
      font-weight: 600;
      font-size: 15px;
    }

    .year {
      font-size: 12px;
      color: #475569;
    }

    .mood-label {
      font-size: 12px;
      color: #1f2933;
    }

    .hint-line {
      font-size: 11px;
      color: #6b7280;
    }

    .stats-card {
      margin-top: 6px;
      margin-bottom: 8px;
      background: #f8fafc;
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    .stat-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .stat-row:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      width: 80px;
      color: #475569;
    }

    .stat-bar {
      flex: 1;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-right: 6px;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.15);
    }

    .stat-fill {
      height: 100%;
      width: 50%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #facc15, #f97316);
      transition: width 0.25s ease;
    }

    .stat-value {
      width: 32px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #111827;
    }

    .actions {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      background: linear-gradient(135deg, #e5f4ff, #dbeafe);
      color: #1e293b;
      box-shadow: 0 3px 0 rgba(148, 163, 184, 0.9);
      transition: transform 0.06s ease, box-shadow 0.06s ease, filter 0.2s;
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 16px;
    }

    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 rgba(148, 163, 184, 0.7);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #eef2ff;
      box-shadow: 0 3px 0 #312e81;
    }

    .btn-warn {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #7f1d1d;
      box-shadow: 0 3px 0 #b91c1c;
    }

    .career-actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .btn-small {
      font-size: 11px;
      padding: 6px 4px;
      box-shadow: 0 2px 0 rgba(148, 163, 184, 0.9);
    }

    .btn-career {
      background: linear-gradient(135deg, #fef3c7, #fee2e2);
      color: #7c2d12;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    .save-controls button {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      cursor: pointer;
    }

    .save-controls button:active {
      transform: translateY(1px);
    }

    .auto-save-hint {
      font-size: 10px;
      color: #6b7280;
      text-align: right;
    }

    .log {
      margin-top: 6px;
      font-size: 11px;
      background: #fefce8;
      border-radius: 11px;
      padding: 6px 8px;
      max-height: 90px;
      overflow-y: auto;
      border: 1px solid #facc15;
    }

    .log-line {
      margin: 0;
      line-height: 1.4;
    }

    /* Ending modal */
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .modal-backdrop.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      width: 85%;
      max-width: 320px;
      background: #f9fafb;
      border-radius: 18px;
      padding: 14px 16px 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.9);
      text-align: center;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal-sub {
      font-size: 13px;
      color: #374151;
      margin-bottom: 8px;
    }

    .modal-body {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 10px;
      text-align: left;
      line-height: 1.5;
    }

    .modal-button {
      margin-top: 4px;
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #eef2ff;
      cursor: pointer;
      box-shadow: 0 3px 0 #312e81;
    }

    .modal-tag {
      font-size: 11px;
      color: #ef4444;
      margin-bottom: 4px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="game">
    <div class="header">
      <div class="title">ç¤¾å“¡è‚²æˆã‚²ãƒ¼ãƒ </div>
      <div id="company-name" class="company-tag">ï¼§ï¼¯ï¼²ï¼¯å•†äº‹</div>
    </div>

    <div class="money-line">
      <span class="label">æ‰€æŒé‡‘ï¼š</span>
      <span id="money-text">Â¥50ä¸‡</span>
    </div>

    <div class="employee-area">
      <div class="avatar-wrapper">
        <div id="avatar-bg" class="avatar-circle stage-junior">
          <div class="avatar-body">
            <div class="head">
              <div class="hair"></div>
              <div id="eye-left" class="eye left"></div>
              <div id="eye-right" class="eye right"></div>
              <div id="mouth" class="mouth neutral"></div>
            </div>
            <div class="suit"></div>
            <div class="shirt"></div>
            <div class="tie"></div>
            <div id="stage-pill" class="stage-pill">æ–°å…¥ç¤¾å“¡</div>
          </div>
        </div>
      </div>

      <div class="status-texts">
        <div class="name-line">
          <div class="name">ç¤¾å“¡ï¼šå±±ç”° å¤ªéƒ</div>
          <div class="year" id="year-text">å…¥ç¤¾ 0.0 å¹´ç›®</div>
        </div>
        <div class="mood-label" id="mood-label">æ°—åˆ†ï¼šãµã¤ã†</div>
        <div class="hint-line">
          ãƒãƒ©ãƒ³ã‚¹ã‚ˆãåƒã‹ã›ã¦ã€<b>ãƒ¡ãƒ³ã‚¿ãƒ«</b>ã¨<b>è©•ä¾¡</b>ã¨<b>ãŠé‡‘</b>ã‚’å®ˆã‚ã†ã€‚
        </div>
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-row">
        <div class="stat-label">ä½“åŠ›</div>
        <div class="stat-bar">
          <div id="energy-bar" class="stat-fill"></div>
        </div>
        <div id="energy-val" class="stat-value">80</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">ãƒ¡ãƒ³ã‚¿ãƒ«</div>
        <div class="stat-bar">
          <div id="mental-bar" class="stat-fill"></div>
        </div>
        <div id="mental-val" class="stat-value">80</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">ä»•äº‹ã®è©•ä¾¡</div>
        <div class="stat-bar">
          <div id="performance-bar" class="stat-fill"></div>
        </div>
        <div id="performance-val" class="stat-value">70</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="work-btn">
        <span class="icon">ğŸ’»</span><span>é›†ä¸­ã—ã¦ä»•äº‹</span>
      </button>
      <button class="btn" id="break-btn">
        <span class="icon">â˜•</span><span>ä¼‘æ†©ãƒ»ã‚³ãƒ¼ãƒ’ãƒ¼</span>
      </button>
      <button class="btn" id="study-btn">
        <span class="icon">ğŸ“š</span><span>è‡ªå·±ç ”ä¿®</span>
      </button>
      <button class="btn btn-warn" id="overtime-btn">
        <span class="icon">ğŸŒ™</span><span>æ®‹æ¥­ã™ã‚‹</span>
      </button>
    </div>

    <div class="career-actions">
      <button class="btn btn-small btn-career" id="transfer-btn">
        ğŸ§³ è»¢è·ã™ã‚‹
      </button>
      <button class="btn btn-small btn-career" id="headhunt-btn">
        ğŸ“„ ãƒ˜ãƒƒãƒ‰ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°
      </button>
      <button class="btn btn-small btn-career" id="dispatch-btn">
        âœˆ æ—¥æœ¬åˆ†ç¤¾ã¸å‡ºå‘
      </button>
    </div>

    <div class="footer-row">
      <div class="save-controls">
        <button id="save-btn">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
        <button id="reset-btn">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="auto-save-hint">â€»30ç§’ã”ã¨ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–ï¼†å®šæœŸçš„ã«çµ¦æ–™æ—¥</div>
    </div>

    <div id="log" class="log"></div>

    <!-- Ending Modal -->
    <div id="ending-backdrop" class="modal-backdrop">
      <div class="modal">
        <div id="ending-tag" class="modal-tag">ENDING</div>
        <div id="ending-title" class="modal-title">é€€ç¤¾ END</div>
        <div id="ending-sub" class="modal-sub">ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚</div>
        <div id="ending-body" class="modal-body">
          ã“ã“ã«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®å†…å®¹ãŒå…¥ã‚Šã¾ã™ã€‚
        </div>
        <button id="ending-restart" class="modal-button">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
      </div>
    </div>
  </div>

  <script>
    const SAVE_KEY = "goro_salaryman_game_v2";

    let state = {
      energy: 80,        // ä½“åŠ›
      mental: 80,        // ãƒ¡ãƒ³ã‚¿ãƒ«
      performance: 70,   // ä»•äº‹ã®è©•ä¾¡
      year: 0,           // å…¥ç¤¾å¹´æ•°
      money: 50,         // æ‰€æŒé‡‘ï¼ˆä¸‡ï¼‰
      salaryBase: 25,    // åŸºæœ¬çµ¦ï¼ˆä¸‡ / çµ¦æ–™ã‚µã‚¤ã‚¯ãƒ«ï¼‰
      livingCost: 18,    // ç”Ÿæ´»è²»ï¼ˆä¸‡ / ã‚µã‚¤ã‚¯ãƒ«ï¼‰
      bonusRate: 0.3,    // ãƒœãƒ¼ãƒŠã‚¹ä¿‚æ•°
      companyName: "ï¼§ï¼¯ï¼²ï¼¯å•†äº‹",
      payrollProgress: 0, // 0.1 å¹´ã”ã¨ã«çµ¦æ–™æ—¥
      lastSaved: Date.now()
    };

    let gameOver = false;
    let tickTimer = null;
    let autoSaveTimer = null;

    // DOM
    const energyBar = document.getElementById("energy-bar");
    const mentalBar = document.getElementById("mental-bar");
    const performanceBar = document.getElementById("performance-bar");
    const energyVal = document.getElementById("energy-val");
    const mentalVal = document.getElementById("mental-val");
    const performanceVal = document.getElementById("performance-val");
    const yearText = document.getElementById("year-text");
    const moodLabel = document.getElementById("mood-label");
    const logBox = document.getElementById("log");
    const avatarBg = document.getElementById("avatar-bg");
    const stagePill = document.getElementById("stage-pill");
    const eyeLeft = document.getElementById("eye-left");
    const eyeRight = document.getElementById("eye-right");
    const mouth = document.getElementById("mouth");
    const companyNameEl = document.getElementById("company-name");
    const moneyText = document.getElementById("money-text");

    const btnWork = document.getElementById("work-btn");
    const btnBreak = document.getElementById("break-btn");
    const btnStudy = document.getElementById("study-btn");
    const btnOvertime = document.getElementById("overtime-btn");
    const btnTransfer = document.getElementById("transfer-btn");
    const btnHeadhunt = document.getElementById("headhunt-btn");
    const btnDispatch = document.getElementById("dispatch-btn");
    const btnSave = document.getElementById("save-btn");
    const btnReset = document.getElementById("reset-btn");

    const endingBackdrop = document.getElementById("ending-backdrop");
    const endingTag = document.getElementById("ending-tag");
    const endingTitle = document.getElementById("ending-title");
    const endingSub = document.getElementById("ending-sub");
    const endingBody = document.getElementById("ending-body");
    const endingRestart = document.getElementById("ending-restart");

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function addLog(text) {
      const line = document.createElement("p");
      line.className = "log-line";
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      line.textContent = `[${hh}:${mm}] ${text}`;
      logBox.prepend(line);
      while (logBox.children.length > 9) {
        logBox.removeChild(logBox.lastChild);
      }
    }

    function saveState(showLog = true) {
      if (gameOver) return;
      state.lastSaved = Date.now();
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
      if (showLog) addLog("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚ï¼ˆï¼§ï¼¯ï¼²ï¼¯å•†äº‹ãƒ©ã‚¤ãƒ•ã‚’ä¿å­˜ï¼‰");
    }

    function loadState() {
      const saved = localStorage.getItem(SAVE_KEY);
      if (!saved) return;
      try {
        const obj = JSON.parse(saved);
        state = { ...state, ...obj };
        addLog("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        addLog("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    function updateStageAndSalary() {
      const y = state.year;
      let cls = "stage-junior";
      let label = "æ–°å…¥ç¤¾å“¡";
      let salaryBase = 25;
      let livingCost = 18;

      if (y >= 1 && y < 3) {
        cls = "stage-mid";
        label = "ä¸­å …ç¤¾å“¡";
        salaryBase = 32;
        livingCost = 20;
      } else if (y >= 3 && y < 6) {
        cls = "stage-leader";
        label = "ãƒªãƒ¼ãƒ€ãƒ¼";
        salaryBase = 40;
        livingCost = 22;
      } else if (y >= 6) {
        cls = "stage-manager";
        label = "ç®¡ç†è·";
        salaryBase = 55;
        livingCost = 26;
      }

      avatarBg.classList.remove(
        "stage-junior",
        "stage-mid",
        "stage-leader",
        "stage-manager"
      );
      avatarBg.classList.add(cls);
      stagePill.textContent = label;

      // è·ä½ã«å¿œã˜ã¦åŸºæœ¬çµ¦ãƒ»ç”Ÿæ´»è²»ã‚’èª¿æ•´ï¼ˆè»¢è·ãƒ»å‡ºå‘ã§å¤‰ãˆã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ä¸‹é™ã¨ã—ã¦ä¸Šæ›¸ãï¼‰
      state.salaryBase = Math.max(state.salaryBase, salaryBase);
      state.livingCost = Math.max(state.livingCost, livingCost);
    }

    function updateFace() {
      const avg = (state.energy + state.mental + state.performance) / 3;
      eyeLeft.classList.remove("happy", "tired");
      eyeRight.classList.remove("happy", "tired");
      mouth.classList.remove("smile", "sad", "neutral");

      let moodText = "ãµã¤ã†";

      if (avg >= 85) {
        moodText = "æœ€é«˜ã«ãƒã£ã¦ã„ã‚‹ï¼";
        eyeLeft.classList.add("happy");
        eyeRight.classList.add("happy");
        mouth.classList.add("smile");
      } else if (avg >= 65) {
        moodText = "èª¿å­ã¯æ‚ªããªã„ã€‚";
        mouth.classList.add("neutral");
      } else if (avg >= 45) {
        moodText = "å°‘ã—ãŠç–²ã‚Œæ°—å‘³â€¦";
        eyeLeft.classList.add("tired");
        eyeRight.classList.add("tired");
        mouth.classList.add("neutral");
      } else {
        moodText = "é™ç•Œã«è¿‘ã„â€¦ä¼‘ã¾ã›ã¦ã‚ã’ã¦ã€‚";
        eyeLeft.classList.add("tired");
        eyeRight.classList.add("tired");
        mouth.classList.add("sad");
      }

      moodLabel.textContent = `æ°—åˆ†ï¼š${moodText}`;
    }

    function updateMoneyUI() {
      moneyText.textContent = `Â¥${state.money.toFixed(1)}ä¸‡`;
      companyNameEl.textContent = state.companyName;
    }

    function updateStatsUI() {
      energyBar.style.width = `${state.energy}%`;
      mentalBar.style.width = `${state.mental}%`;
      performanceBar.style.width = `${state.performance}%`;

      energyVal.textContent = Math.round(state.energy);
      mentalVal.textContent = Math.round(state.mental);
      performanceVal.textContent = Math.round(state.performance);

      yearText.textContent = `å…¥ç¤¾ ${state.year.toFixed(1)} å¹´ç›®`;

      updateStageAndSalary();
      updateFace();
      updateMoneyUI();
    }

    function bumpAvatar() {
      avatarBg.style.transform = "translateY(-4px)";
      setTimeout(() => {
        avatarBg.style.transform = "translateY(0)";
      }, 150);
    }

    // Ending
    function triggerEnding(type) {
      if (gameOver) return;
      gameOver = true;

      if (tickTimer) clearInterval(tickTimer);
      if (autoSaveTimer) clearInterval(autoSaveTimer);

      btnWork.disabled = true;
      btnBreak.disabled = true;
      btnStudy.disabled = true;
      btnOvertime.disabled = true;
      btnTransfer.disabled = true;
      btnHeadhunt.disabled = true;
      btnDispatch.disabled = true;
      btnSave.disabled = true;

      let tag = "ENDING";
      let title = "";
      let sub = "";
      let body = "";

      switch (type) {
        case "mental":
          tag = "é¬±æ†¤çˆ†ç™º END";
          title = "å¿ƒãŒæŠ˜ã‚Œã¦ã—ã¾ã£ãŸâ€¦";
          sub = "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒé™ç•Œã‚’è¶…ãˆãŸã‚ˆã†ã§ã™ã€‚";
          body =
            "é•·æ™‚é–“ã®æ®‹æ¥­ã¨ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«ã‚ˆã‚Šã€å±±ç”°ã•ã‚“ã®ãƒ¡ãƒ³ã‚¿ãƒ«ã¯ã»ã¼ã‚¼ãƒ­ã«ã€‚\n\nã€Œã‚‚ã†ç„¡ç†ã ã€ã¨ä¼šç¤¾ã«é€€è·å±Šã‚’å‡ºã—ã¾ã—ãŸã€‚\n\næ–°ã—ã„äººç”ŸãŒã€ã“ã“ã‹ã‚‰å§‹ã¾ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
          break;
        case "fired":
          tag = "é€€ç¤¾ END";
          title = "ã‚¯ãƒ“ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚";
          sub = "è©•ä¾¡ãŒã‚ã¾ã‚Šã«ä½ããªã£ã¦ã—ã¾ã£ãŸâ€¦ã€‚";
          body =
            "ä»•äº‹ã®è©•ä¾¡ãŒä¸‹ãŒã‚Šç¶šã‘ã€ã¤ã„ã«ä¸Šå¸ã‹ã‚‰ã€Œã“ã‚Œä»¥ä¸Šã¯å³ã—ã„ã€ã¨å‘Šã’ã‚‰ã‚Œã¾ã—ãŸã€‚\n\nå±±ç”°ã•ã‚“ã¯ã€æ‚”ã—ã•ã¨ã‚¹ãƒƒã‚­ãƒªã—ãŸæ°—æŒã¡ã‚’æŠ±ãˆãªãŒã‚‰ä¼šç¤¾ã‚’å¾Œã«ã—ã¾ã—ãŸã€‚";
          break;
        case "body":
          tag = "èº«ä½“ã‚¬ã‚¿ã‚¬ã‚¿ END";
          title = "ä½“ãŒå‹•ã‹ãªããªã£ãŸã€‚";
          sub = "ä½“åŠ›ãŒå°½ãã¦ã—ã¾ã£ãŸã€‚";
          body =
            "ä¼‘æ†©ã‚‚ã»ã¨ã‚“ã©å–ã‚‰ãšã€æ®‹æ¥­ãƒ»ä¼‘æ—¥å‡ºå‹¤ã‚’ç¹°ã‚Šè¿”ã—ãŸçµæœã€å±±ç”°ã•ã‚“ã¯ã¤ã„ã«å€’ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚\n\nåŒ»è€…ã‹ã‚‰ã¯ã€Œã—ã°ã‚‰ãä¼‘è·ãŒå¿…è¦ã§ã™ã€ã¨å®£å‘Šã•ã‚Œã¾ã™ã€‚";
          break;
        case "shachiku":
          tag = "é™ç•Œç¤¾ç•œ END";
          title = "æ°—ã¥ã„ãŸã‚‰ç¤¾ç•œã®å®Œæˆå½¢ã€‚";
          sub = "ä½“åŠ›ã‚‚ãƒ¡ãƒ³ã‚¿ãƒ«ã‚‚ã‚®ãƒªã‚®ãƒªã®ã¾ã¾åƒãç¶šã‘ãŸçµæœâ€¦ã€‚";
          body =
            "æœã‹ã‚‰çµ‚é›»ã¾ã§åƒãã€ä¼‘æ—¥ã‚‚å®¶ã§è³‡æ–™ä½œã‚Šã€‚\n\nè‡ªåˆ†ã®ãŸã‚ã®ãŠé‡‘ã‚‚æ™‚é–“ã‚‚ãªã„ã¾ã¾ã€ãŸã è©•ä¾¡ã®ãŸã‚ã«èµ°ã‚Šç¶šã‘ãŸçµæœã€å±±ç”°ã•ã‚“ã¯ã€Œä½•ã®ãŸã‚ã«ç”Ÿãã¦ã„ã‚‹ã®ã‹ã€ã‚ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚";
          break;
        default:
          tag = "ENDING";
          title = "ï¼§ï¼¯ï¼²ï¼¯å•†äº‹ã§ã®ç‰©èªãŒçµ‚ã‚ã‚‹ã€‚";
          sub = "ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
          body = "å±±ç”°ã•ã‚“ã®ç¤¾ä¼šäººãƒ©ã‚¤ãƒ•ã¯ã€ã“ã“ã§ã²ã¨åŒºåˆ‡ã‚Šã‚’è¿ãˆã¾ã—ãŸã€‚";
          break;
      }

      endingTag.textContent = tag;
      endingTitle.textContent = title;
      endingSub.textContent = sub;
      endingBody.textContent = body.replace(/\n/g, "\n");
      endingBackdrop.classList.add("show");

      addLog(`ã€${tag}ã€‘ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚`);
      saveState(false);
    }

    function checkEnding() {
      if (gameOver) return;
      if (state.mental <= 5) {
        triggerEnding("mental");
      } else if (state.performance <= 5) {
        triggerEnding("fired");
      } else if (state.energy <= 5) {
        triggerEnding("body");
      } else if (state.energy < 15 && state.mental < 20 && state.year > 1.0) {
        triggerEnding("shachiku");
      }
    }

    // Action functions
    function doWork() {
      if (gameOver) return;
      state.energy = clamp(state.energy - 8, 0, 100);
      state.mental = clamp(state.mental - 4, 0, 100);
      state.performance = clamp(state.performance + 6, 0, 100);
      addLog("é›†ä¸­ã—ã¦ä»•äº‹ã‚’ã—ãŸã€‚è©•ä¾¡ã¯ä¸ŠãŒã‚‹ãŒã€å°‘ã—ç–²ã‚ŒãŸã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    function doBreak() {
      if (gameOver) return;
      state.energy = clamp(state.energy + 10, 0, 100);
      state.mental = clamp(state.mental + 12, 0, 100);
      state.performance = clamp(state.performance - 2, 0, 100);
      addLog("ã‚³ãƒ¼ãƒ’ãƒ¼ä¼‘æ†©ã€‚ä½“åŠ›ã¨ãƒ¡ãƒ³ã‚¿ãƒ«ãŒå›å¾©ã—ãŸã€‚è©•ä¾¡ã¯å°‘ã—ã ã‘ãƒ€ã‚¦ãƒ³ã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    function doStudy() {
      if (gameOver) return;
      state.energy = clamp(state.energy - 5, 0, 100);
      state.mental = clamp(state.mental - 2, 0, 100);
      state.performance = clamp(state.performance + 4, 0, 100);
      addLog("æ¥­å‹™å¾Œã«è‡ªå·±ç ”ä¿®ã€‚ã˜ã‚ã˜ã‚è©•ä¾¡ã‚¢ãƒƒãƒ—ã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    function doOvertime() {
      if (gameOver) return;
      state.energy = clamp(state.energy - 15, 0, 100);
      state.mental = clamp(state.mental - 12, 0, 100);
      state.performance = clamp(state.performance + 10, 0, 100);
      addLog("æ·±å¤œã¾ã§æ®‹æ¥­â€¦ã€‚å¤§ããè©•ä¾¡ã‚¢ãƒƒãƒ—ã ãŒã€ãƒ¡ãƒ³ã‚¿ãƒ«ã¨ä½“åŠ›ãŒå±é™ºã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    // Career actions
    function doTransfer() {
      if (gameOver) return;
      state.companyName = "ï¼§ï¼¯ï¼²ï¼¯ã‚­ãƒ£ãƒªã‚¢ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚º";
      state.energy = clamp(state.energy + 5, 0, 100);
      state.mental = clamp(state.mental + 10, 0, 100);
      state.performance = clamp(state.performance - 8, 0, 100);
      state.salaryBase = state.salaryBase + 5;
      state.livingCost = state.livingCost + 3;
      addLog("è»¢è·ã—ãŸï¼ç’°å¢ƒã¯å¤‰ã‚ã£ãŸãŒã€ã¾ãŸä¸€ã‹ã‚‰ä¿¡é ¼ã‚’ç©ã¿ä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    function doHeadhunt() {
      if (gameOver) return;
      if (state.performance < 70) {
        addLog("ãƒ˜ãƒƒãƒ‰ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°ã®è©±ã¯æ¥ã¦ã„ãªã„â€¦ï¼ˆè©•ä¾¡ãŒã¾ã è¶³ã‚Šãªã„ã‚ˆã†ã ï¼‰ã€‚");
        return;
      }
      state.companyName = "ï¼§ï¼¯ï¼²ï¼¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹";
      state.energy = clamp(state.energy - 5, 0, 100);
      state.mental = clamp(state.mental + 5, 0, 100);
      state.salaryBase = state.salaryBase + 12;
      state.livingCost = state.livingCost + 6;
      state.money += 15; // ã‚µã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹
      addLog("ãƒ˜ãƒƒãƒ‰ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°ã§å¹´åã‚¢ãƒƒãƒ—ï¼ã‚µã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚‚ã‚‚ã‚‰ã£ãŸã€‚è²¬ä»»ã¯ã•ã‚‰ã«é‡ããªã£ãŸã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    function doDispatch() {
      if (gameOver) return;
      state.companyName = "ï¼§ï¼¯ï¼²ï¼¯å•†äº‹ æ—¥æœ¬åˆ†ç¤¾";
      state.energy = clamp(state.energy - 3, 0, 100);
      state.mental = clamp(state.mental - 1, 0, 100);
      state.performance = clamp(state.performance + 4, 0, 100);
      state.salaryBase = state.salaryBase + 4;
      state.livingCost = state.livingCost + 4;
      state.money += 5; // å‡ºå‘æ‰‹å½“
      addLog("æ—¥æœ¬åˆ†ç¤¾ã¸å‡ºå‘ã€‚å‡ºå‘æ‰‹å½“ã§å°‘ã—åå…¥ã‚¢ãƒƒãƒ—ã€‚ç’°å¢ƒã‚‚ä»•äº‹å†…å®¹ã‚‚å¤‰åŒ–ã—ãŸã€‚");
      bumpAvatar();
      updateStatsUI();
      saveState(false);
      checkEnding();
    }

    // Salary system
    function doPayroll() {
      // 0.1å¹´ã”ã¨ã«å‘¼ã°ã‚Œã‚‹æƒ³å®š
      const base = state.salaryBase;
      const perfBonus =
        state.performance > 50
          ? Math.max(0, Math.round((state.performance - 50) * state.bonusRate) / 10)
          : 0;
      const bonus = Math.round(perfBonus * 10) / 10; // å°æ•°1ä½
      const cost = state.livingCost;

      const net = base + bonus - cost;
      state.money = Math.round((state.money + net) * 10) / 10;

      addLog(
        `çµ¦æ–™æ—¥ï¼šåŸºæœ¬çµ¦ ${base.toFixed(1)}ä¸‡ + ãƒœãƒ¼ãƒŠã‚¹ ${bonus.toFixed(
          1
        )}ä¸‡ - ç”Ÿæ´»è²» ${cost.toFixed(1)}ä¸‡ = æ‰‹å–ã‚Š ${net.toFixed(1)}ä¸‡`
      );
      updateMoneyUI();
    }

    // Tick
    function tick() {
      if (gameOver) return;

      state.year += 0.02; // ç´„5ç§’ã§0.02å¹´ï¼ˆ0.1å¹´=ç´„25ç§’ï¼‰
      state.payrollProgress += 0.02;

      // è‡ªç„¶æ¸›
      state.energy = clamp(state.energy - 1.4, 0, 100);

      if (state.energy < 40) {
        state.mental = clamp(state.mental - 1.3, 0, 100);
      } else if (state.energy < 60) {
        state.mental = clamp(state.mental - 0.6, 0, 100);
      } else {
        state.mental = clamp(state.mental + 0.2, 0, 100);
      }

      if (state.mental >= 70 && state.energy >= 60) {
        state.performance = clamp(state.performance + 0.6, 0, 100);
      } else if (state.mental < 35) {
        state.performance = clamp(state.performance - 0.6, 0, 100);
      }

      if (state.payrollProgress >= 0.1) {
        state.payrollProgress -= 0.1;
        doPayroll();
      }

      updateStatsUI();
      checkEnding();
    }

    function autoSaveTick() {
      if (!gameOver) saveState(false);
    }

    function resetGame() {
      if (!confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;
      localStorage.removeItem(SAVE_KEY);
      state = {
        energy: 80,
        mental: 80,
        performance: 70,
        year: 0,
        money: 50,
        salaryBase: 25,
        livingCost: 18,
        bonusRate: 0.3,
        companyName: "ï¼§ï¼¯ï¼²ï¼¯å•†äº‹",
        payrollProgress: 0,
        lastSaved: Date.now()
      };
      gameOver = false;
      endingBackdrop.classList.remove("show");

      btnWork.disabled = false;
      btnBreak.disabled = false;
      btnStudy.disabled = false;
      btnOvertime.disabled = false;
      btnTransfer.disabled = false;
      btnHeadhunt.disabled = false;
      btnDispatch.disabled = false;
      btnSave.disabled = false;

      addLog("ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ–°å…¥ç¤¾å“¡ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
      updateStatsUI();

      if (tickTimer) clearInterval(tickTimer);
      if (autoSaveTimer) clearInterval(autoSaveTimer);
      tickTimer = setInterval(tick, 5000);
      autoSaveTimer = setInterval(autoSaveTick, 30000);
      saveState(false);
    }

    function init() {
      loadState();
      updateStatsUI();

      btnWork.addEventListener("click", doWork);
      btnBreak.addEventListener("click", doBreak);
      btnStudy.addEventListener("click", doStudy);
      btnOvertime.addEventListener("click", doOvertime);
      btnTransfer.addEventListener("click", doTransfer);
      btnHeadhunt.addEventListener("click", doHeadhunt);
      btnDispatch.addEventListener("click", doDispatch);
      btnSave.addEventListener("click", () => saveState(true));
      btnReset.addEventListener("click", resetGame);

      endingRestart.addEventListener("click", resetGame);

      tickTimer = setInterval(tick, 5000);        // 5ç§’ã”ã¨ã«çŠ¶æ…‹å¤‰åŒ–
      autoSaveTimer = setInterval(autoSaveTick, 30000); // 30ç§’ã”ã¨ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–

      addLog("å±±ç”°ã•ã‚“ãŒï¼§ï¼¯ï¼²ï¼¯å•†äº‹ã«å…¥ç¤¾ã—ã¾ã—ãŸã€‚ã†ã¾ãè‚²ã¦ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚");
    }

    init();
  </script>
</body>
</html>
